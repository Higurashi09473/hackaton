#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

# 1. –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 8888 (Go —Å–µ—Ä–≤–µ—Ä)
echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 8888..."
PID_8888=$(lsof -ti:8888 2>/dev/null)
if [ ! -z "$PID_8888" ]; then
    echo "–ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å $PID_8888 –Ω–∞ –ø–æ—Ä—Ç—É 8888. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
    kill -9 $PID_8888 2>/dev/null
    sleep 2
fi

# 2. –£–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 5173 (Vite –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
echo "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ –ø–æ—Ä—Ç—É 5173..."
PID_5173=$(lsof -ti:5173 2>/dev/null)
if [ ! -z "$PID_5173" ]; then
    echo "–ù–∞–π–¥–µ–Ω –ø—Ä–æ—Ü–µ—Å—Å $PID_5173 –Ω–∞ –ø–æ—Ä—Ç—É 5173. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
    kill -9 $PID_5173 2>/dev/null
    sleep 2
fi

# 3. –ó–∞–ø—É—Å–∫–∞–µ–º Go –±—ç–∫–µ–Ω–¥
echo "–ó–∞–ø—É—Å–∫–∞–µ–º Go –±—ç–∫–µ–Ω–¥..."
cd backend && go run cmd/main.go &

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –±—ç–∫–µ–Ω–¥–∞
echo "–ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –±—ç–∫–µ–Ω–¥–∞ (5 —Å–µ–∫—É–Ω–¥)..."
sleep 5

# 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±—ç–∫–µ–Ω–¥ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if lsof -ti:8888 > /dev/null; then
    echo "‚úÖ –ë—ç–∫–µ–Ω–¥ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8888"
else
    echo "‚ùå –û—à–∏–±–∫–∞: –±—ç–∫–µ–Ω–¥ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    exit 1
fi

# 5. –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
echo "–ó–∞–ø—É—Å–∫–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥..."
cd ../frontend && npm run dev --host &

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
echo "–ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (5 —Å–µ–∫—É–Ω–¥)..."
sleep 5

# 6. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
if lsof -ti:5173 > /dev/null; then
    echo "‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 5173"
    echo ""
    echo "========================================"
    echo "üöÄ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!"
    echo "üîó –ë—ç–∫–µ–Ω–¥: http://localhost:8888"
    echo "üîó –§—Ä–æ–Ω—Ç–µ–Ω–¥: http://localhost:5173"
    echo "========================================"
else
    echo "‚ö†Ô∏è  –§—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω –Ω–∞ –¥—Ä—É–≥–æ–º –ø–æ—Ä—Ç—É"
fi

# 7. –°–æ—Ö—Ä–∞–Ω—è–µ–º PID –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –≤ —Ñ–∞–π–ª –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
echo $! > ../backend.pid
echo $(lsof -ti:5173) > ../frontend.pid

echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ: ./stop.sh"
